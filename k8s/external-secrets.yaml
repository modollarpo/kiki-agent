# =============================================================================
# AWS Secrets Manager Integration (Primary)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: kiki-aws-store
  namespace: kiki
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: kiki-sa
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kiki-sa
  namespace: kiki
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/kiki-sa-role"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kiki-secrets-aws
  namespace: kiki
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: kiki-aws-store
    kind: SecretStore
  target:
    name: kiki-runtime-secrets
    creationPolicy: Owner
  data:
    # Messaging/Email
    - secretKey: SENDGRID_API_KEY
      remoteRef:
        key: kiki/prod/sendgrid_api_key
    - secretKey: TWILIO_ACCOUNT_SID
      remoteRef:
        key: kiki/prod/twilio_account_sid
    - secretKey: TWILIO_AUTH_TOKEN
      remoteRef:
        key: kiki/prod/twilio_auth_token
    # CRM Integration
    - secretKey: SALESFORCE_CLIENT_ID
      remoteRef:
        key: kiki/prod/salesforce_client_id
    - secretKey: SALESFORCE_CLIENT_SECRET
      remoteRef:
        key: kiki/prod/salesforce_client_secret
    - secretKey: HUBSPOT_PRIVATE_APP_TOKEN
      remoteRef:
        key: kiki/prod/hubspot_token
    - secretKey: SHOPIFY_API_KEY
      remoteRef:
        key: kiki/prod/shopify_api_key
    - secretKey: SHOPIFY_API_SECRET
      remoteRef:
        key: kiki/prod/shopify_api_secret
    # Database
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: kiki/prod/postgres_password
    # Redis (if managed)
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: kiki/prod/redis_password
---
# =============================================================================
# Azure Key Vault Integration (Alternative)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: kiki-azure-store
  namespace: kiki
  # Only create if using Azure
spec:
  provider:
    azurekv:
      authType: workloadIdentity
      vaultUrl: https://kiki-prod.vault.azure.net
      tenantId: AZURE_TENANT_ID
      clientId: AZURE_CLIENT_ID
---
# =============================================================================
# GCP Secret Manager Integration (Alternative)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: kiki-gcp-store
  namespace: kiki
  # Only create if using GCP
spec:
  provider:
    gcpsm:
      projectID: kiki-prod-project
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: kiki-prod-gke
          serviceAccountRef:
            name: kiki-sa
---
# =============================================================================
# Environment Secrets for Helm (sensitive defaults, override in CD)
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: kiki-helm-secrets
  namespace: kiki
type: Opaque
stringData:
  # AWS credentials for External Secrets operator (if not using IRSA)
  AWS_ACCESS_KEY_ID: "REPLACE_ME"
  AWS_SECRET_ACCESS_KEY: "REPLACE_ME"
  # kubeconfig for CD workflow (base64 in GitHub Actions secret)
  KUBECONFIG_BASE64: "REPLACE_ME"
